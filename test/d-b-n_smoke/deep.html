<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <!-- Importing Web Component's Polyfill -->
    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="../shared/helpers.html">
    <script src="../../../web-component-tester/browser.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../palindrom-polymer.html">
    <link rel="import" href="../../../palindrom-connection/palindrom-connection.html">

</head>

<body>
    <palindrom-connection remote-url="/palindrom" ping-interval-s="0"></palindrom-connection>
    <palindrom-polymer ref="deep"></palindrom-polymer>
    <template is="dom-bind" id="deep">

        <h3>{{model.name}}</h3>
        by
        <span id="author">{{model.author.first}}</span>

    </template>
    <script>
        describe('palindrom-polymer, when stamped from `dom-bind` with deep attribute and bound to object', function () {
            var model, domBind, ppclient, palindrom;
            beforeEach(function waitForHTMLImportsAndDomBindChange(done) {
                model = {
                    name: "<palindrom-polymer>",
                    author: {
                        first: "Tomek",
                        last: "WytrÄ™bowicz"
                    }
                };
                domBind = document.getElementById("deep");
                domBind.model = model;
                ppclient = document.querySelector('palindrom-connection');
                palindrom = ppclient.palindrom;
                setTimeout(() => {
                    initPalindrom(palindrom, model);
                    done();
                }, 100)
            });
            describe('should observe changes to it,', function () {
                if (navigator.vendor && navigator.vendor.indexOf('Apple') > -1) {
                    it.skip('fire a change event, and update dom-bind - IGNORED ON SAFARI #24');
                } else {
                    it('fire a change event, and update dom-bind', function (done) {
                        var patchAppliedEventCallback = sinon.spy();
                        ppclient.addEventListener('patch-applied', patchAppliedEventCallback);

                        // change model
                        palindromChange(palindrom, [operationObject('replace', '/author/first', 'tomalec')]);

                        // check and wait for async dom-bind's stamping
                        // temporary construct. See #23
                        function tryAssertion() {
                            if (patchAppliedEventCallback.called
                                && document.getElementById("author").innerHTML == "tomalec") {
                                done();
                            }
                            else {
                                console.info('Assertion didn\'t pass');
                                console.info('patchAppliedEventCallback.called: ', patchAppliedEventCallback.called);
                                console.info('document.getElementById("author").innerHTML: ', document.getElementById("author").innerHTML);
                            }
                        }
                        setInterval(tryAssertion, 100); // Mocha timeouts after 10 seconds

                    });
                }
            });
        });
    </script>

</body>

</html>