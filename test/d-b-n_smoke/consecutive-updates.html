<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <title>Test consecutive updates behavior, this was buggy in Polymer 1.x</title>
    <!-- Importing Web Component's Polyfill -->
    <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="../shared/helpers.html">

    <script src="../../../web-component-tester/browser.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../palindrom-client.html">
</head>

<body>
    <test-fixture id="palindrom-polymer-array">
        <template>
            <!-- workaround for test-fixture bug -->
            <div>
                <palindrom-client remote-url="/palindrom" ref="domBind"></palindrom-client>
                <dom-bind id="domBind">
                    <template>
                        <ul>
                            <dom-repeat items="{{model.array}}">
                                <template>
                                    <li>{{item}}</li>
                                </template>
                            </dom-repeat>
                        </ul>
                    </template>
                </dom-bind>
            </div>
        </template>
    </test-fixture>
    <test-fixture id="polymer-array">
        <template>
            <!-- workaround for test-fixture bug -->
            <div>
                <dom-bind id="domBind">
                    <template>
                        <ul>
                            <dom-repeat items="{{array}}">
                                <template>
                                    <li>{{item}}</li>
                                </template>
                            </dom-repeat>
                        </ul>
                    </template>
                </dom-bind>
            </div>
        </template>
    </test-fixture>
    <script>
        var model;
        describe('when stamped with reference to `dom-bind` and bound to palindrom object w/ array of primitives', function () {
            describe('if two consecutive changes are applied, they should be rendered correctly', function () {
                var container, domBind, ppclient, palindrom, patchAppliedEventCallback;

                beforeEach(function (done) {
                    patchAppliedEventCallback = sinon.spy();
                    model = { array: [0, 1] };

                    container = fixture('palindrom-polymer-array');
                    ppclient = container.querySelector("palindrom-client");
                    palindrom = ppclient.palindrom;
                    initPalindrom(palindrom, model);
                    setTimeout(() => {
                        domBind = container.querySelector('dom-bind');
                        // Polymer werido(m)bind attaches to dom asynchronously
                        setTimeout(done, 10)
                    }, 10);
                });
                afterEach(function (done) {
                    // Polymer werido(m)bind detaches from dom asynchronously
                    setTimeout(done, 10);
                });
                it('First item must be 1 and second must be 2', function (done) {
                    ppclient.addEventListener('patch-applied', patchAppliedEventCallback);
                    // change model
                    palindromChange(palindrom, [operationObject('replace', '/array/0', 1), operationObject('replace', '/array/1', 2)]);

                    // check and wait for the event dispatching
                    setTimeout(function listener() {
                        expect(patchAppliedEventCallback).to.have.been.called;
                        expect(container.querySelector("ul>li:first-child").innerHTML).to.equal('1');
                        expect(container.querySelector("ul>li:nth-child(2)").innerHTML).to.equal('2');
                        done();
                    }, 10);
                });
            });
            describe('`dom-bind` when bound to an array of primitives', function () {
                describe('when two consecutive `splice`s are made, they should be rendered correctly', function () {
                    var container, domBind;

                    beforeEach(function (done) {
                        model = { array: [0, 1] };

                        container = fixture('polymer-array');
                        domBind = container.querySelector('dom-bind');
                        domBind.array = model.array;
                        // Polymer werido(m)bind attaches to dom asynchronously
                        setTimeout(done, 50);

                    });
                    afterEach(function (done) {
                        // Polymer werido(m)bind detaches from dom asynchronously
                        setTimeout(done, 50);
                    });
                    it('Both items should be rendered correctly', function (done) {
                        // change model
                        domBind.splice("array", 0, 1, 1);
                        domBind.splice("array", 1, 1, 2);

                        // check and wait for the event dispatching
                        setTimeout(function listener() {
                            expect(container.querySelector("ul>li:first-child").innerHTML).to.equal('1');
                            expect(container.querySelector("ul>li:nth-child(2)").innerHTML).to.equal('2');
                            done();
                        }, 10);
                    });
                });
            });
        });
    </script>

</body>

</html>